define(["jquery","core/log","core/str","core/templates","core/notification"],function(a,b,c,d,e){var f={DOWN:40,ENTER:13,SPACE:32,ESCAPE:27,COMMA:188,UP:38},g=null,h=function(b,c){var d=a(document.getElementById(c)),e=d.children("[aria-selected=true]").length;for(b%=e;0>b;)b+=e;var f=a(d.children("[aria-selected=true]").get(b)),g=c+"-"+b;d.children().attr("data-active-selection",!1).attr("id",""),f.attr("data-active-selection",!0).attr("id",g),d.attr("aria-activedescendant",g)},i=function(b,c,d,e,f){var g=a(d).attr("data-value");f&&e.children("option").each(function(b,c){a(c).attr("value")==g&&(a(c).prop("selected",!1),a(c).attr("data-iscustom")&&a(c).remove())}),r(c,b,e,f)},j=function(b,c,d){var e=a(document.getElementById(c)),f=a(document.getElementById(d)),g=f.children("[aria-hidden=false]").length;for(b%=g;0>b;)b+=g;var h=a(f.children("[aria-hidden=false]").get(b)),i=a(f.children("[role=option]")).index(h),j=d+"-"+i;f.children().attr("aria-selected",!1).attr("id",""),h.attr("aria-selected",!0).attr("id",j),e.attr("aria-activedescendant",j)},k=function(b,c){var d=a(document.getElementById(c)),e=d.children("[aria-selected=true]"),f=d.children("[aria-hidden=false]").index(e);j(f+1,b,c)},l=function(b){var c=a(document.getElementById(b)),d=c.children("[data-active-selection=true]");if(!d)return void h(0,b);var e=c.children("[aria-selected=true]").index(d);h(e-1,b)},m=function(b){var c=a(document.getElementById(b)),d=c.children("[data-active-selection=true]");if(!d)return void h(0,b);var e=c.children("[aria-selected=true]").index(d);h(e+1,b)},n=function(b,c){var d=a(document.getElementById(c)),e=d.children("[aria-selected=true]"),f=d.children("[aria-hidden=false]").index(e);j(f-1,b,c)},o=function(b,c,d){var e=a(document.getElementById(b)),f=a(document.getElementById(c));e.attr("aria-expanded",!1).attr("aria-activedescendant",d),f.hide().attr("aria-hidden",!0)},p=function(b,f,g,h,i,k){var l=a(document.getElementById(f)),m=a(document.getElementById(g)),n=!1,o=[];h.children("option").each(function(b,c){a(c).prop("selected")!==!0&&(o[o.length]={label:c.innerHTML,value:a(c).attr("value")})}),d.render("core/form_autocomplete_suggestions",{inputId:f,suggestionsId:g,options:o,multiple:i}).done(function(d){m.replaceWith(d),m=a(document.getElementById(g)),m.show().attr("aria-hidden",!1),m.children().each(function(c,d){d=a(d),d.text().indexOf(b)>-1?(d.show().attr("aria-hidden",!1),n=!0):d.hide().attr("aria-hidden",!0)}),l.attr("aria-expanded",!0),n?k||j(0,f,g):c.get_string("nosuggestions","form").done(function(a){m.html(a)})}).fail(e.exception)},q=function(b,c,d,e,f){var g=a(document.getElementById(b)),h=g.val(),i=h.split(","),j=!1;a.each(i,function(b,c){if(c=c.trim(),""!==c&&(e||f.children("option").prop("selected",!1),f.children("option").each(function(b,d){a(d).attr("value")==c&&(j=!0,a(d).prop("selected",!0))}),!j)){var d=a("<option>");d.append(c),d.attr("value",c),f.append(d),d.prop("selected",!0),d.attr("data-iscustom",!0)}}),r(d,b,f,e),g.val(""),o(b,c,d)},r=function(b,c,f,g){var i=[],j=a(document.getElementById(b)),k=j.attr("aria-activedescendant"),l=!1;k&&(l=a(document.getElementById(k)).attr("data-value")),f.children("option").each(function(b,c){a(c).prop("selected")&&i.push({label:a(c).html(),value:a(c).attr("value")})});var m={selectionId:b,items:i,multiple:g};d.render("core/form_autocomplete_selection",m).done(function(c){j.empty().append(a(c).html()),l!==!1&&j.children("[aria-selected=true]").each(function(c,d){a(d).attr("data-value")===l&&h(c,b)})}).fail(e.exception),f.change()},s=function(b,c,d,e,f){var g=a(document.getElementById(b)),h=a(document.getElementById(c)),i=h.children("[aria-selected=true]").attr("data-value");e||f.children("option").prop("selected",!1),f.children("option").each(function(b,c){a(c).attr("value")==i&&a(c).prop("selected",!0)}),r(d,b,f,e),g.val(""),o(b,c,d)},t=function(b,c,d,f,g,h,i,j){var k=a(b.currentTarget).val();j.transport(c,k,function(b){var e=j.processResults(c,b),k=[];g.children("option").each(function(b,c){c=a(c),c.prop("selected")?k.push(c.attr("value")):c.remove()}),a.each(e,function(b,c){if(-1===k.indexOf(c.value)){var d=a("<option>");d.append(c.label),d.attr("value",c.value),g.append(d)}}),p("",d,f,g,h,i)},e.exception)},u=function(b,c,d,e,h,r,t){var u=a(document.getElementById(b));u.on("keydown",function(d){switch(d.keyCode){case f.DOWN:return"true"===u.attr("aria-expanded")?k(b,c):p(u.val(),b,c,h,r,t),d.preventDefault(),!1;case f.COMMA:return t&&q(b,c,e,r,h),d.preventDefault(),!1;case f.UP:return n(b,c),d.preventDefault(),!1;case f.ENTER:var g=a(document.getElementById(c));return"true"===u.attr("aria-expanded")&&g.children("[aria-selected=true]").length>0?s(b,c,e,r,h):t&&q(b,c,e,r,h),d.preventDefault(),!1;case f.ESCAPE:return"true"===u.attr("aria-expanded")&&o(b,c,e),d.preventDefault(),!1}return!0}),u.on("behat:set-value",function(){t&&q(b,c,e,r,h)}),u.on("blur focus",function(a){g&&window.clearTimeout(g),g=window.setTimeout(function(){"blur"==a.type&&t&&q(b,c,e,r,h),o(b,c,e)},500)});var v=a(document.getElementById(d));v.on("click",function(){u.focus(),g&&window.clearTimeout(g),p(u.val(),b,c,h,r,t)});var w=a(document.getElementById(c));w.parent().on("click","[role=option]",function(d){var f=a(d.currentTarget).closest("[role=option]"),g=a(document.getElementById(c)),i=g.children("[aria-hidden=false]").index(f);j(i,b,c),s(b,c,e,r,h)});var x=a(document.getElementById(e));x.parent().on("click","[role=listitem]",function(c){var d=a(c.currentTarget);i(b,e,d,h,r)}),x.parent().on("keydown",function(c){switch(c.keyCode){case f.DOWN:return m(e),c.preventDefault(),!1;case f.UP:return l(e),c.preventDefault(),!1;case f.SPACE:case f.ENTER:var d=a(document.getElementById(e)).children("[data-active-selection=true]");return d&&(i(b,e,d,h,r),c.preventDefault()),!1}return!0}),u.on("input",function(d){var e=a(d.currentTarget).val();p(e,b,c,h,r,t)})};return{enhance:function(c,e,f,g){"undefined"==typeof e&&(e=!1),"undefined"==typeof f&&(f=!1);var h=a(c);if(!h)return b.debug("Selector not found: "+c),!1;h.hide().attr("aria-hidden",!0);var i=h.attr("id"),j=h.attr("multiple"),k="form_autocomplete_input-"+a.now(),l="form_autocomplete_suggestions-"+a.now(),m="form_autocomplete_selection-"+a.now(),n="form_autocomplete_downarrow-"+a.now(),o=a("[for="+i+"]"),p=[];h.children("option").each(function(b,c){p[b]={label:c.innerHTML,value:a(c).attr("value")}});var q=d.render("core/form_autocomplete_input",{downArrowId:n,inputId:k,suggestionsId:l,selectionId:m,placeholder:g,multiple:j}),s=d.render("core/form_autocomplete_suggestions",{inputId:k,suggestionsId:l,options:p,multiple:j}),v=d.render("core/form_autocomplete_selection",{selectionId:m,items:[],multiple:j});a.when(q,s,v).done(function(b,d,g){h.after(d),h.after(b),h.after(g),o.attr("for",k),u(k,l,n,m,h,j,e);var i=a(document.getElementById(k)),p=a(document.getElementById(l));p.hide().attr("aria-hidden",!0),f&&require([f],function(b){var d=function(a){t(a,c,k,l,h,j,e,b)};i.on("input keypress",d);var f=a(document.getElementById(n));f.on("click",d)}),r(m,k,h,j)})}}});
