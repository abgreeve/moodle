define(["jqueryui","jquery"],function(a,b){var c=null,d=9999,e=function(a,c){if(0!==c&&document.getElementById("mod_lesson_page_element_"+a)&&document.getElementById("mod_lesson_page_element_"+c)){var d=b("#mod_lesson_page_element_"+a).offset(),e=b("#mod_lesson_page_element_"+c).offset(),f=d.left+b("#mod_lesson_page_element_"+a).width(),g=d.top+b("#mod_lesson_page_element_"+a).height(),h=Math.sqrt((e.left-f)*(e.left-f)+(e.top-g)*(e.top-g)),i=Math.atan2(g-e.top,f-e.left)*(180/Math.PI),j=(f+e.left)/2-h/2,k=(g+e.top)/2-1,l="<div class='lessonline' style='left:"+j+"px; top:"+k+"px; width:"+h+"px; -moz-transform:rotate("+i+"deg); -webkit-transform:rotate("+i+"deg); -o-transform:rotate("+i+"deg); -ms-transform:rotate("+i+"deg); transform:rotate("+i+"deg);' />";b("body").append(l)}},f=function(){b(".lessonline").remove();for(var a in c)for(var d=c[a],f=0,g=0,h="jumpto["+f+"]";d.hasOwnProperty(h);)g="-1"===d[h]?d.nextpageid:d[h],"31"===d.qtype?e(d.clusterid,g):"-9"===g?e(d.id,d.id+"1"):"cluster"!==d.location&&e(d.id,g),f+=1,h="jumpto["+f+"]"},g=function(){for(var a in c)for(var d=0,e=0,f="jumpto["+d+"]";c[a].hasOwnProperty(f);){if(e="-1"===c[a][f]?c[a].nextpageid:c[a][f],"-9"===e){var g="<div class='mod_lesson_page_element' id='mod_lesson_page_element_"+a+"1'><header id='mod_lesson_page_element_"+a+"1'>End Of Lesson</header>";g+="<div class='mod_lesson_page_body' id='mod_lesson_page_element_"+a+"1'></div></div>",b("#mod_lesson_page_element_"+a).append(g);var h=a+"1",i={id:h,prevpageid:a,nextpageid:"none",qtype:"-1",eolid:h};c[h]=i}d+=1,f="jumpto["+d+"]"}},h=function(){for(var a in c){var d=c[a];if("30"===c[a].qtype){var e=270,f=100,g=(b("#mod_lesson_page_element_"+a).width(),b("#mod_lesson_page_element_"+a).height()),h=0,i=0;d.clusterchildrenids.length>3?(h=3*e,i=g+Math.ceil(d.clusterchildrenids.length/3)*f):(h=e*d.clusterchildrenids.length,i=g+1*f),b("#mod_lesson_page_element_"+a).width(h),b("#mod_lesson_page_element_"+a).height(i);var j=b("#mod_lesson_page_element_"+a).offset().left+10,k=j,l=b("#mod_lesson_page_element_"+a).offset().top+80;for(var m in d.clusterchildrenids)m%3===0&&"0"!==m?(l+=110,b("#mod_lesson_page_element_"+d.clusterchildrenids[m]).offset({top:l,left:j}),k=j+b("#mod_lesson_page_element_"+d.clusterchildrenids[m]).width()+30):(b("#mod_lesson_page_element_"+d.clusterchildrenids[m]).offset({top:l,left:k}),k=k+b("#mod_lesson_page_element_"+d.clusterchildrenids[m]).width()+30)}}},i=function(){var a="<div class='mod_lesson_menu_item'>Content</div>";b(".mod_lesson_menu").append(a),b(".mod_lesson_menu_item").draggable({stop:function(a,c){if(!c.helper.hasClass("mod_lesson_page_element")){var e=c.helper.offset();c.helper.addClass("mod_lesson_page_element"),c.helper.removeClass("mod_lesson_menu_item"),c.helper.attr("id","mod_lesson_page_element_"+d);var f='<header id="mod_lesson_page_element_'+d+'">Content</header>';f+='<div class="mod_lesson_page_body" id="mod_lesson_page_element_'+d+'"></div>',b("#mod_lesson_page_element_"+d).html(f),c.helper.detach(),b(".mod_lesson_pages").append(c.helper),b("#mod_lesson_page_element_"+d).offset(e),d+=1}}})};return{init:function(a){console.log(a),c=a,g(),h(),f(),b(".mod_lesson_page_element").draggable({drag:f}),b(".mod_lesson_menu_item").draggable({stop:function(a,c){console.log("still bound");var e=c.helper.offset();c.helper.addClass("mod_lesson_page_element"),c.helper.removeClass("mod_lesson_menu_item"),c.helper.attr("id","mod_lesson_page_element_"+d);var f='<header id="mod_lesson_page_element_'+d+'">Content</header>';f+='<div class="mod_lesson_page_body" id="mod_lesson_page_element_'+d+'"></div>',b("#mod_lesson_page_element_"+d).html(f),c.helper.detach(),b(".mod_lesson_pages").append(c.helper),b("#mod_lesson_page_element_"+d).offset(e),d+=1}}),b(".mod_lesson_menu").droppable({out:i,drop:function(a,b){b.draggable.remove()}}),b(".mod_lesson_pages").on("click",".mod_lesson_page_element",function(){var c=this.id,d=c.split("_"),e=d[4],f=b(this).offset();a[e].x=f.left,a[e].y=f.top})}}});