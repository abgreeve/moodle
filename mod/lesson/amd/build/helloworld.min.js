define(["jqueryui","jquery"],function(a,b){var c=null,d=0,e="ajax.php",f=function(a,c){if(0!==c&&document.getElementById("mod_lesson_page_element_"+a)&&document.getElementById("mod_lesson_page_element_"+c)){var d=b("#mod_lesson_page_element_"+a).offset(),e=b("#mod_lesson_page_element_"+c).offset(),f=d.left+b("#mod_lesson_page_element_"+a).width(),g=d.top+b("#mod_lesson_page_element_"+a).height(),h=Math.sqrt((e.left-f)*(e.left-f)+(e.top-g)*(e.top-g)),i=Math.atan2(g-e.top,f-e.left)*(180/Math.PI),j=(f+e.left)/2-h/2,k=(g+e.top)/2-1,l="<div class='lessonline' style='left:"+j+"px; top:"+k+"px; width:"+h+"px;";l+=" -moz-transform:rotate("+i+"deg); -webkit-transform:rotate("+i+"deg);",l+=" -o-transform:rotate("+i+"deg); -ms-transform:rotate("+i+"deg);",l+=" transform:rotate("+i+"deg);' />",b("body").append(l)}},g=function(){b(".lessonline").remove();for(var a in c)for(var d=c[a],e=0,g=0,h="jumpto["+e+"]";d.hasOwnProperty(h);)g="-1"===d[h]?d.nextpageid:d[h],"31"===d.qtype?f(d.clusterid,g):"-9"===g?f(d.id,d.id+"1"):"cluster"!==d.location&&f(d.id,g),e+=1,h="jumpto["+e+"]"},h=function(){for(var a in c)for(var d=0,e=0,f="jumpto["+d+"]";c[a].hasOwnProperty(f);){if(e="-1"===c[a][f]?c[a].nextpageid:c[a][f],"-9"===e){var g="<div class='mod_lesson_page_element' id='mod_lesson_page_element_"+a+"1'>";g+="<header id='mod_lesson_page_element_"+a+"1'>End Of Lesson</header>",g+="<div class='mod_lesson_page_body' id='mod_lesson_page_element_"+a+"1'></div></div>",b("#mod_lesson_page_element_"+a).append(g);var h=a+"1",i={id:h,prevpageid:a,nextpageid:"none",qtype:"-1",eolid:h};c[h]=i}d+=1,f="jumpto["+d+"]"}},i=function(a,c){var d=b(this).find(c.helper).length;d||(c.helper.detach(),b(this).append(c.helper))},j=function(a,c){var d=b(this).find(c.helper).length;d&&(c.helper.detach(),b(".mod_lesson_pages").append(c.helper),c.helper.offset({left:a.pageX,top:a.pageY}))},k=function(){for(var a in c){var d=c[a];if("30"===c[a].qtype){var e=270,f=100,g=b("#mod_lesson_page_element_"+a).height(),h=0,k=0;d.clusterchildrenids.length>3?(h=3*e,k=g+Math.ceil(d.clusterchildrenids.length/3)*f):(h=e*d.clusterchildrenids.length,k=g+1*f),b("#mod_lesson_page_element_"+a).width(h),b("#mod_lesson_page_element_"+a).height(k);var l=b("#mod_lesson_page_element_"+a).offset().left+10,m=l,n=b("#mod_lesson_page_element_"+a).offset().top+80;for(var o in d.clusterchildrenids)o%3===0&&"0"!==o?(n+=110,b("#mod_lesson_page_element_"+d.clusterchildrenids[o]).offset({top:n,left:l}),m=l+b("#mod_lesson_page_element_"+d.clusterchildrenids[o]).width()+30):(b("#mod_lesson_page_element_"+d.clusterchildrenids[o]).offset({top:n,left:m}),m=m+b("#mod_lesson_page_element_"+d.clusterchildrenids[o]).width()+30);b("#mod_lesson_page_element_"+a).droppable({drop:i,out:j})}}},l=function(){var a="<div class='mod_lesson_menu_item'>Content</div>";b(".mod_lesson_menu").append(a),b(".mod_lesson_menu_item").draggable({stop:m})},m=function(a,f){if(!f.helper.hasClass("mod_lesson_page_element")){var g=f.helper.offset();f.helper.addClass("mod_lesson_page_element"),f.helper.removeClass("mod_lesson_menu_item");var h={title:"Default title",contents:"",qtype:"20",lessonid:d,location:"normal",previouspageid:"0",nextpageid:"0",positionx:Math.round(g.left),positiony:Math.round(g.top)};b.ajax({method:"POST",url:e,dataType:"json",data:{action:"createcontent",lessonid:d,lessondata:h}}).done(function(a){console.log(a),f.helper.attr("id","mod_lesson_page_element_"+a);var e='<header id="mod_lesson_page_element_'+a+'">Content</header>';e+='<div class="mod_lesson_page_body" id="mod_lesson_page_element_'+a+'"></div>',b("#mod_lesson_page_element_"+a).html(e),c[a]={title:"Default title",contents:"",qtype:"20",lessonid:d,location:"normal",previouspageid:"0",nextpageid:"0"},f.helper.detach(),b(".mod_lesson_pages").append(f.helper),b("#mod_lesson_page_element_"+a).offset(g)}).fail(function(a){console.log(a)})}o()},n=function(a){a.stopPropagation();var d=this.id,e=d.split("_"),f=e[4],g='<div class="mod_lesson_page_editor">';g+="<h3>Edit this lesson page </h3>",g+="<div>Page title</div>",g+='<div><input type="text" id="mod_lesson_title" value="'+c[f].title+'" /></div>',g+="<div>Page contents</div>",g+='<div><textarea id="mod_lesson_contents">'+c[f].contents+"</textarea></div>",g+="</div>",b(".mod_lesson_pages").append(g),b(".mod_lesson_page_editor").dblclick(function(){b(this).remove()})},o=function(){b(".mod_lesson_page_element").draggable({drag:g}),b(".mod_lesson_page_element").unbind("dblclick"),b(".mod_lesson_page_element").on({dblclick:n}),b(".mod_lesson_menu_item").draggable({stop:m})};return{init:function(a){console.log(a),c=a;var e;for(e in c)break;d=c[e].lessonid,h(),k(),g(),o(),b(".mod_lesson_menu").droppable({out:l,drop:function(a,b){b.draggable.remove()}})}}});