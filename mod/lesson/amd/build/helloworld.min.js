define(["jqueryui","jquery"],function(a,b){var c=null,d=0,e="ajax.php",f=null,g=!0,h=function(a){this.add_lessonpage=function(a,b){switch(parseInt(b.qtype)){case 31:this.pages[a]=new k(b);break;case 30:this.pages[a]=new j(b);break;case 21:this.pages[a]=new o(b);break;case 20:this.pages[a]=new p(b);break;case 10:this.pages[a]=new q(b);break;case 8:this.pages[a]=new m(b);break;case 5:this.pages[a]=new r(b);break;case 3:this.pages[a]=new s(b);break;case 2:this.pages[a]=new l(b);break;case 1:this.pages[a]=new n(b);break;default:this.pages[a]=new i(b)}},this.id=d,this.pages={};for(lessonpage in a)this.add_lessonpage(lessonpage,a[lessonpage])},i=function(a){this.id=a.id,this.qtype=parseInt(a.qtype),this.lessonid=a.lessonid,this.title=a.title,this.contents=a.contents,this.positionx=a.positionx,this.positiony=a.positiony,this.qtypestring=a.qtypestr,this.nextpageid=a.nextpageid,this.previouspageid=a.prevpageid,this.location=a.location,a.hasOwnProperty("clusterid")&&(this.clusterid=a.clusterid),a.hasOwnProperty("subclusterid")&&(this.subclusterid=a.subclusterid),this.jumps={};for(var b in a.answers)this.jumps[parseInt(a.answers[b].id)]={id:parseInt(a.answers[b].id),jumpto:parseInt(a.answers[b].jumpto),answer:a.answers[b].answer,response:a.answers[b].response,score:a.answers[b].score};0===Object.keys(this.jumps).length&&(this.jumps[0]={jumpto:-1,answer:"Next page",response:"",score:0},this.qtype<11&&(this.jumps[1]={jumpto:0,answer:"This page",response:"",score:0})),"subclusterchildrenids"in a?this.childrenids=a.subclusterchildrenids:this.childrenids=[]};i.prototype={in_cluster:function(){return"cluster"===this.location},in_subcluster:function(){return"subcluster"===this.location},update_jumps:function(a){if("undefined"==typeof a){var c=this;b.ajax({method:"POST",url:e,dataType:"json",data:{action:"getjumprecords",lessonid:d,lessondata:{pageid:this.id}}}).done(function(a){for(index in c.jumps)delete c.jumps[index];for(jumpid in a)c.jumps[parseInt(a[jumpid].id)]={id:parseInt(a[jumpid].id),jumpto:parseInt(a[jumpid].jumpto),answer:a[jumpid].answer,response:a[jumpid].response,score:a[jumpid].score}})}else{for(index in this.jumps)delete this.jumps[index];for(jumpid in a)this.jumps[parseInt(a[jumpid].id)]={id:parseInt(a[jumpid].id),jumpto:parseInt(a[jumpid].jumpto),answer:a[jumpid].answer,response:a[jumpid].response,score:a[jumpid].score}}},get_default_edit_form:function(){var a='<div class="mod_lesson_page_editor">';return a+="<h3>Edit this "+this.qtypestring+" </h3>",a+=t(this.id,this.title),a+=u(this.id,this.contents)},save_edit_form:function(){var a={},c=1,g=0,h=this;b(".mod_lesson_editor_answer").each(function(){var d=b("#mod_lesson_answer_"+c).val(),e=b("#mod_lesson_jump_select_"+c).val(),f=b(this).attr("id").split("_")[4],i="",j=0;b("#mod_lesson_response_"+c).length&&(i=b("#mod_lesson_response_"+c).val()),b("#mod_lesson_score_"+c).length&&(j=b("#mod_lesson_score_"+c).val()),Object.keys(h.jumps).length<=g?h.jumps[g]={jumpto:e,answer:d,response:i,score:j}:(h.jumps[f].jumpto=e,h.jumps[f].answer=d,h.jumps[f].response=i,h.jumps[f].score=j),a[c]={answer:d,jumpto:e,response:i,score:j},c++,g++});var i=b("#mod_lesson_title_"+this.id).val(),j=b("#mod_lesson_contents_"+this.id).val();this.title=i,this.contents=j;var k={page:{id:this.id,title:i,contents:j},answer:{lessonid:f.id,pageid:this.id,jumps:a}},l=JSON.stringify(k),m=this.id;b.ajax({method:"POST",url:e,dataType:"json",data:{action:"updatelessonpage",lessonid:d,jsondata:l}}).done(function(a){b("#mod_lesson_page_element_"+m+"_body").html(i),b(".mod_lesson_page_editor").remove(),b("#mod_lesson_editor_addjump_btn").unbind("click"),x()})}};var j=function(a){i.call(this,a),"clusterchildrenids"in a?this.childrenids=a.clusterchildrenids:this.childrenids=[]};j.prototype={in_cluster:function(){return i.prototype.in_cluster.call(this)},in_subcluster:function(){return!1},update_jumps:function(a){i.prototype.update_jumps.call(this,a)},get_edit_form:function(a){return p.prototype.get_edit_form.call(this,a)},save_edit_form:function(){i.prototype.save_edit_form.call(this)},get_end_of_clusterid:function(){if("undefined"!=typeof this.endofclusterid)return this.endofclusterid;for(var a in f.pages)if("End of cluster"==f.pages[a].qtypestring&&parseInt(f.pages[a].clusterid)==this.id)return this.endofclusterid=f.pages[a].id,this.endofclusterid;console.log("no id found")}};var k=function(a){i.call(this,a)};k.prototype={in_cluster:function(){return i.prototype.in_cluster.call(this)},in_subcluster:function(){return!1},update_jumps:function(a){i.prototype.update_jumps.call(this,a)}};var l=function(a){i.call(this,a)};l.prototype={in_cluster:function(){return i.prototype.in_cluster.call(this)},in_subcluster:function(){return i.prototype.in_subcluster.call(this)},update_jumps:function(a){i.prototype.update_jumps.call(this,a)},get_edit_form:function(a){var b=i.prototype.get_default_edit_form.call(this),c=1;b+='<div id="mod_lesson_editor_answers">';for(jumpid in this.jumps)b+='<div class="mod_lesson_editor_answer" id="mod_lesson_editor_answer_'+jumpid+'">',b+=1==c?"<h4>Correct response</h4>":2==c?"<h4>Wrong response</h4>":"<h4>Extra response that should be removed</h4>",b+="<div>Answer</div>",b+='<div><input type="text" id="mod_lesson_answer_'+c+'" value="'+this.jumps[jumpid].answer+'"/></div>',b+="<div>Response</div>",b+='<div><textarea id="mod_lesson_response_'+c+'">'+this.jumps[jumpid].response+"</textarea></div>",b+=v(this.jumps[jumpid].jumpto,this.id,a,c),b+="<div>Score</div>",b+='<div><input type="text" id="mod_lesson_score_'+c+'" value="'+this.jumps[jumpid].score+'"/></div>',b+="</div>",c++;return b+="</div>",b+='<div><button type="button" id="mod_lesson_editor_save_btn">Save</button>',b+='<button type="button" id="mod_lesson_editor_cancel_btn">Cancel</button>',b+="</div></div>"},save_edit_form:function(){i.prototype.save_edit_form.call(this)}};var m=function(a){i.call(this,a)};m.prototype={in_cluster:function(){return i.prototype.in_cluster.call(this)},in_subcluster:function(){return i.prototype.in_subcluster.call(this)},update_jumps:function(a){i.prototype.update_jumps.call(this,a)},get_edit_form:function(a){var b=i.prototype.get_default_edit_form.call(this),c=1;b+='<div id="mod_lesson_editor_answers">';for(jumpid in this.jumps)b+='<div class="mod_lesson_editor_answer" id="mod_lesson_editor_answer_'+jumpid+'">',b+="<h4>Answer "+c+"</h4>",b+="<div>Answer</div>",b+='<div><input type="text" id="mod_lesson_answer_'+c+'" value="'+this.jumps[jumpid].answer+'"/></div>',b+="<div>Response</div>",b+='<div><textarea id="mod_lesson_response_'+c+'">'+this.jumps[jumpid].response+"</textarea></div>",b+=v(this.jumps[jumpid].jumpto,this.id,a,c),b+="<div>Score</div>",b+='<div><input type="text" id="mod_lesson_score_'+c+'" value="'+this.jumps[jumpid].score+'"/></div>',b+="</div>",c++;return b+="</div>",b+='<div><button type="button" id="mod_lesson_editor_save_btn">Save</button>',b+='<button type="button" id="mod_lesson_editor_cancel_btn">Cancel</button>',b+='<button type="button" id="mod_lesson_editor_addjump_btn">Add another jump</button>',b+="</div></div>"},save_edit_form:function(){i.prototype.save_edit_form.call(this)},add_additional_jump:function(a){for(var c=a.data.jumpoptions,d=1;b("#mod_lesson_answer_"+d).length;)d++;var e='<div class="mod_lesson_editor_answer" id="mod_lesson_editor_answer_0">';e+="<h4>Answer "+d+"</h4>",e+="<div>Answer</div>",e+='<div><input type="text" id="mod_lesson_answer_'+d+'" value=""/></div>',e+="<div>Response</div>",e+='<div><textarea id="mod_lesson_response_'+d+'"></textarea></div>',e+=v(0,this.id,c,d),e+="<div>Score</div>",e+='<div><input type="text" id="mod_lesson_score_'+d+'" value=""/></div>',e+="</div>",b("#mod_lesson_editor_answers").append(e)}};var n=function(a){i.call(this,a)};n.prototype={in_cluster:function(){return i.prototype.in_cluster.call(this)},in_subcluster:function(){return i.prototype.in_subcluster.call(this)},update_jumps:function(a){i.prototype.update_jumps.call(this,a)},get_edit_form:function(a){return p.prototype.get_edit_form.call(this,a)},save_edit_form:function(){i.prototype.save_edit_form.call(this)}};var o=function(a){i.call(this,a)};o.prototype={in_cluster:function(){return i.prototype.in_cluster.call(this)},in_subcluster:function(){return i.prototype.in_subcluster.call(this)},update_jumps:function(a){i.prototype.update_jumps.call(this,a)}};var p=function(a){i.call(this,a)};p.prototype={in_cluster:function(){return i.prototype.in_cluster.call(this)},in_subcluster:function(){return i.prototype.in_subcluster.call(this)},update_jumps:function(a){i.prototype.update_jumps.call(this,a)},get_edit_form:function(a){var b=i.prototype.get_default_edit_form.call(this),c=1;b+='<div id="mod_lesson_editor_answers">';for(jumpid in this.jumps)b+='<div class="mod_lesson_editor_answer" id="mod_lesson_editor_answer_'+jumpid+'">',b+="<h4>Content "+c+"</h4>",b+="<div>Jump name</div>",b+='<div><input type="text" id="mod_lesson_answer_'+c+'" value="'+this.jumps[jumpid].answer+'"/></div>',b+=v(this.jumps[jumpid].jumpto,this.id,a,c),b+="</div>",c++;return b+="</div>",b+='<div><button type="button" id="mod_lesson_editor_save_btn">Save</button>',b+='<button type="button" id="mod_lesson_editor_cancel_btn">Cancel</button>',b+='<button type="button" id="mod_lesson_editor_addjump_btn">Add another jump</button>',b+="</div></div>"},add_additional_jump:function(a){for(var c=a.data.jumpoptions,d=1;b("#mod_lesson_answer_"+d).length;)d++;var e='<div class="mod_lesson_editor_answer" id="mod_lesson_editor_answer_0">';e+="<h4>Content "+d+"</h4>",e+="<div>Jump name</div>",e+='<div><input type="text" id="mod_lesson_answer_'+d+'" value=""/></div>',e+=v(0,this.id,c,d),e+="</div>",b("#mod_lesson_editor_answers").append(e)},save_edit_form:function(){i.prototype.save_edit_form.call(this)}};var q=function(a){i.call(this,a)};q.prototype={in_cluster:function(){return i.prototype.in_cluster.call(this)},in_subcluster:function(){return i.prototype.in_subcluster.call(this)},update_jumps:function(a){i.prototype.update_jumps.call(this,a)},get_edit_form:function(a){return p.prototype.get_edit_form.call(this,a)},save_edit_form:function(){i.prototype.save_edit_form.call(this)}};var r=function(a){i.call(this,a)};r.prototype={in_cluster:function(){return i.prototype.in_cluster.call(this)},in_subcluster:function(){return i.prototype.in_subcluster.call(this)},update_jumps:function(a){i.prototype.update_jumps.call(this,a)},get_edit_form:function(a){return p.prototype.get_edit_form.call(this,a)},save_edit_form:function(){i.prototype.save_edit_form.call(this)}};var s=function(a){i.call(this,a)};s.prototype={in_cluster:function(){return i.prototype.in_cluster.call(this)},in_subcluster:function(){return i.prototype.in_subcluster.call(this)},update_jumps:function(a){i.prototype.update_jumps.call(this,a)},get_edit_form:function(a){return m.prototype.get_edit_form.call(this,a)},save_edit_form:function(){i.prototype.save_edit_form.call(this)},add_additional_jump:function(a){m.prototype.add_additional_jump.call(this,a)}};var t=function(a,b){var c;return c="<div>Page Title</div>",c+='<div><input type="input" class="mod_lesson_title" id="mod_lesson_title_'+a+'" value="'+b+'" /></div>'},u=function(a,b){var c;return c="<div>Page Content</div>",c+='<div><textarea id="mod_lesson_contents_'+a+'">'+b+"</textarea></div>"},v=function(a,b,c,d){var e;e="<div>Jump</div>",e+='<select id="mod_lesson_jump_select_'+d+'">';for(index in c)e+=a==index?'<option value="'+index+'" selected>'+c[index]+"</option>":'<option value="'+index+'">'+c[index]+"</option>";return e+="</select>"},w=function(a,c,d){if(0!==c&&document.getElementById("mod_lesson_page_element_"+a)&&document.getElementById("mod_lesson_page_element_"+c)){var e=b(".mod_lesson_pages").scrollTop(),g=b(".mod_lesson_pages").scrollLeft(),h=b("#mod_lesson_page_element_"+a).position(),i=b("#mod_lesson_page_element_"+c).position();h.top=h.top+1*e+15,i.top=i.top+1*e+15,h.left=h.left+1*g,i.left=i.left+1*g;var j=h.left+b("#mod_lesson_page_element_"+a).width(),k=h.top+b("#mod_lesson_page_element_"+a).height(),l=Math.sqrt((i.left-j)*(i.left-j)+(i.top-k)*(i.top-k)),m=Math.atan2(k-i.top,j-i.left)*(180/Math.PI),n=(j+i.left)/2-l/2,o=(k+i.top)/2-1,p="<div class='lessonline' style='left:"+n+"px; top:"+o+"px; width:"+l+"px;";p+=" -moz-transform:rotate("+m+"deg); -webkit-transform:rotate("+m+"deg);",p+=" -o-transform:rotate("+m+"deg); -ms-transform:rotate("+m+"deg);",p+=" transform:rotate("+m+"deg);' />",b(".mod_lesson_pages").append(p);var q=o-15,r=(j+i.left)/2-15,s="";"Cluster"==f.pages[a].qtypestring&&(a=f.pages[a].get_end_of_clusterid()),s="Answer: "+f.pages[a].jumps[d].answer;var t="#000000";f.pages[a].jumps[d].score>0&&(t="#00ff00");var u="<div class='mod_lesson_jump_circle' id='mod_lesson_jump_circle_"+a+"_"+d+"'";u+=" style='left:"+r+"px; top:"+q+"px; border-color: "+t,u+=" ' data-toggle='tooltip' title='"+s+"'><center><img src='../../theme/image.php?theme=clean&component=core&image=t%2Fedit' class='mod_lesson_jump_menu' /></center></div>",b(".mod_lesson_pages").append(u),m+=90;var v="<div class='mod_lesson_jump_arrow' style='-moz-transform:rotate("+m+"deg); -webkit-transform:rotate("+m+"deg);";v+=" -o-transform:rotate("+m+"deg); -ms-transform:rotate("+m+"deg); transform:rotate("+m+"deg);'>",v+="<img src='../../theme/image.php?theme=clean&component=core&image=t%2Fdropdown' />",v+="</div>",b("#mod_lesson_jump_circle_"+a+"_"+d).append(v)}},x=function(){b(".lessonline").remove(),b(".mod_lesson_jump_circle").remove(),b(".mod_lesson_jump_arrow").remove();for(lpid in f.pages){var a=f.pages[lpid];for(jumpid in a.jumps)a.jumps[jumpid].jumpto==-1?nextpageid=a.nextpageid:nextpageid=a.jumps[jumpid].jumpto,31==a.qtype?w(a.clusterid,nextpageid,a.jumps[jumpid].id):"-9"===nextpageid?w(a.id,a.id+"1",a.jumps[jumpid].id):a.in_cluster()||a.in_subcluster()||w(a.id,nextpageid,a.jumps[jumpid].id)}b(".mod_lesson_jump_circle").on({click:O})},y=function(a,c){var g=c.helper.attr("id");console.log(g);var h=g.split("_"),i=h[4],j=b(this).find(c.helper).length;if(!j){var k=b(this).attr("id");h=k.split("_");var l=h[4];f.pages[i].location="cluster";var m=null;if(20==f.pages[i].qtype){f.pages[i].location="subcluster",record={qtype:"21",lessonid:f.id,title:"Default title",contents:"",positionx:0,positiony:0,prevpageid:i,nextpageid:0};var n=b.Deferred(),o=b.ajax({method:"POST",url:e,dataType:"json",data:{action:"createcontent",lessonid:d,lessondata:record}});o.done(function(a){n.resolve(a)}),o.fail(function(a){console.log(a)}),m=n.promise()}var p=null;p=f.pages[l].childrenids.length>0?f.pages[l].childrenids[f.pages[l].childrenids.length-1]:f.pages[l].id,b.when(i,m).done(function(a,c){var d=[a];null!==c&&(f.add_lessonpage(c.id,c),f.pages[c.prevpageid].nextpageid=c.id,f.pages[c.id].qtypestr="End of branch",f.pages[c.id].location="subcluster",f.pages[c.id].subclusterid=a,f.pages[c.id].nextpageid=l,d.push(c.id));for(index in d){b.inArray(d[index],f.pages[l].childrenids)==-1&&f.pages[l].childrenids.push(d[index]);var g=f.pages[d[index]].previouspageid,h=f.pages[d[index]].nextpageid;"0"!==g&&(f.pages[g].nextpageid=h),"0"!==h&&(f.pages[h].previouspageid=g)}movepageids=d.join(),lessondata={pageid:movepageids,after:p},b.ajax({method:"POST",url:e,dataType:"json",data:{action:"movepage",lessonid:f.id,lessondata:lessondata}}).done(function(a){A(),B()})}),c.helper.detach(),b(this).append(c.helper)}},z=function(a,c){var d=b(this).find(c.helper).length;d&&(c.helper.detach(),b(".mod_lesson_pages").append(c.helper),A())},A=function(){for(var a in f.pages){var c=f.pages[a];if(30===c.qtype){var d=c.childrenids.length,e=270,g=100,h=b("#mod_lesson_page_element_"+a).height(),i=0,j=0;if(i=e,j=200==h?h:h+1*g,b("#mod_lesson_page_element_"+a).width(i),b("#mod_lesson_page_element_"+a).height(j),d){var k=b("#mod_lesson_page_element_"+a).offset().left+10,l=k,m=b("#mod_lesson_page_element_"+a).offset().top+80;for(var n in c.childrenids)n%3===0&&"0"!==n?(m+=110,b("#mod_lesson_page_element_"+c.childrenids[n]).offset({top:m,left:k}),l=k+b("#mod_lesson_page_element_"+c.childrenids[n]).width()+30):(b("#mod_lesson_page_element_"+c.childrenids[n]).offset({top:m,left:l}),l=l+b("#mod_lesson_page_element_"+c.childrenids[n]).width()+30),b("#mod_lesson_page_element_"+c.childrenids[n]).css("display","none")}b("#mod_lesson_page_element_"+a).droppable({drop:y,out:z})}}},B=function(){for(var a in f.pages){var c=f.pages[a];if(20===c.qtype&&c.in_subcluster()){var d=c.childrenids.length;0===d&&(d=1);var e=250,g=100,h=(b("#mod_lesson_page_element_"+a).height(),0),i=0;d>3?(h=3*e,i=100+Math.ceil(d/3)*g+10):(h=e*d,i=100+1*g),b("#mod_lesson_page_element_"+a).width(h),b("#mod_lesson_page_element_"+a).height(i);var j=b("#mod_lesson_page_element_"+a).offset().left+10,k=j,l=b("#mod_lesson_page_element_"+a).offset().top+80;for(var m in c.childrenids)m%3===0&&"0"!==m?(l+=110,b("#mod_lesson_page_element_"+c.childrenids[m]).offset({top:l,left:j}),k=j+b("#mod_lesson_page_element_"+c.childrenids[m]).width()+30):(b("#mod_lesson_page_element_"+c.childrenids[m]).offset({top:l,left:k}),k=k+b("#mod_lesson_page_element_"+c.childrenids[m]).width()+30);var n="Sub cluster";n+='<img src="../../theme/image.php?theme=clean&component=core&image=t%2Fedit" class="mod_lesson_page_object_menu"></div></header>',b("#mod_lesson_page_element_"+a+"_header").html(n),b("#mod_lesson_page_element_"+a).droppable({drop:y,out:z})}}},C=function(a,c){pagetype=c.helper.text();var d="<div class='mod_lesson_menu_item'>"+pagetype+"</div>";b(".mod_lesson_menu").append(d),b(".mod_lesson_menu_item").draggable({stop:D})},D=function(a,c){var d,g,h,i,j=c.helper.text();switch(j){case"Content":d="20",g="",h="Default title",i="normal";break;case"True False":d="2",g="",h="Default title",i="normal";break;case"Numerical":d="8",g="",h="Default title",i="normal";break;case"Multiple Choice":d="3",g="",h="Default title",i="normal";break;case"Cluster":d="30",g="Cluster",h="Cluster",i="cluster";break;default:d="0",g="",h="Default title",i="normal"}if(!c.helper.hasClass("mod_lesson_page_element")){var k=c.helper.offset();c.helper.addClass("mod_lesson_page_element"),c.helper.removeClass("mod_lesson_menu_item");var l={title:h,contents:g,qtype:d,lessonid:f.id,location:i,previouspageid:"0",nextpageid:"0",positionx:Math.round(k.left),positiony:Math.round(k.top)};b.ajax({method:"POST",url:e,dataType:"json",data:{action:"createcontent",lessonid:f.id,lessondata:l}}).done(function(a){if("31"!==a.qtype){c.helper.attr("id","mod_lesson_page_element_"+a.id);var d='<header id="mod_lesson_page_element_'+a.id+'_header">'+j;d+='<img src="../../theme/image.php?theme=clean&component=core&image=t%2Fedit" class="mod_lesson_page_object_menu"></div></header>',d+='<div class="mod_lesson_page_element_body" id="mod_lesson_page_element_'+a.id+'_body">'+a.title+"</div>",b("#mod_lesson_page_element_"+a.id).html(d)}if(f.add_lessonpage(a.id,a),f.pages[a.prevpageid].nextpageid=a.id,f.pages[a.id].update_jumps(),"30"===a.qtype){var e=parseInt(a.id)+1,g={clusterid:a.id,contents:"End of cluster",id:e,lessonid:f.id,location:"normal",nextpageid:"0",positionx:"0",positiony:"0",qtype:31,qtypestring:"End of cluster",title:"End of cluster"};f.add_lessonpage(e,g),f.pages[a.id].nextpageid=e}"31"!==a.qtype&&(c.helper.detach(),b(".mod_lesson_pages").append(c.helper),b("#mod_lesson_page_element_"+a.id).offset(k),"Cluster"===j&&A(),R(),x())}).fail(function(a){console.log(a)})}x(),R()},E=function(a){var c=b.Deferred(),f=b.ajax({method:"POST",url:e,dataType:"json",data:{action:"getjumpoptions",lessonid:d,pageid:a}});return f.done(function(a){c.resolve(a)}),f.fail(function(a){console.log(a)}),c.promise()},F=function(a){a.preventDefault(),a.stopPropagation();var c=b(this).parents(".mod_lesson_page_element").attr("id"),d=c.split("_"),e=d[4];H(),b.when(E(e)).done(function(a){var c=f.pages[e].get_edit_form(a);b(".mod_lesson_pages").append(c),b("#mod_lesson_editor_addjump_btn").click({jumpoptions:a},f.pages[e].add_additional_jump),b("#mod_lesson_editor_save_btn").click(function(){f.pages[e].save_edit_form()}),b("#mod_lesson_editor_cancel_btn").click(function(){b(".mod_lesson_page_editor").remove()})})},G=function(a){if(b(this).parent().children(".mod_lesson_page_object_menu_thing").length)b(this).parent().find(".mod_lesson_page_object_menu_thing").remove();else{var c='<div class="mod_lesson_page_object_menu_thing">';c+="<ul>",c+='<li><a href="#" class="mod_lesson_page_edit">Edit</a></li>',c+='<li><a href="#" class="mod_lesson_page_link">Link</a></li>',c+='<li><a href="#" class="mod_lesson_page_delete">Delete</a></li>',c+="</ul>",c+="</div>",b(this).parent().append(c),b(".mod_lesson_page_delete").on({click:I}),b(".mod_lesson_page_edit").on({click:F}),b(".mod_lesson_page_link").on({click:J})}},H=function(){b(".mod_lesson_main").find(".mod_lesson_page_object_menu_thing").remove()},I=function(a){a.preventDefault();var c=b(this).parents(".mod_lesson_page_element").attr("id"),g=c.split("_"),h=g[4],i={};if(30==f.pages[h].qtype)for(index in f.pages)parseInt(f.pages[index].clusterid)==h&&(i.endofclusterid=f.pages[index].id);if(20==f.pages[h].qtype)for(index in f.pages)parseInt(f.pages[index].subclusterid)==h&&(i.endofclusterid=f.pages[index].id);b.ajax({method:"POST",url:e,dataType:"json",data:{action:"deletelessonpage",lessonid:d,pageid:h,lessondata:i}}).done(function(){i.endofclusterid.length&&delete f.pages[i.endofclusterid],delete f.pages[h]}).fail(function(a){console.log(a)}),b(this).parents(".mod_lesson_page_element").remove(),H(),x()},J=function(a){a.preventDefault(),a.stopPropagation();var c=b(this).parent().parent().parent().parent().attr("id"),d=c.split("_"),e=d[4];b(".mod_lesson_page_element").click({pageid:e},M),b(".mod_lesson_page_element").hover(K,L)},K=function(){b(this).css("background-color","#b8b8b8")},L=function(){b(this).css("background-color","white")},M=function(a){var c=this.id,g=c.split("_"),h=g[4],i=a.data.pageid;b(".mod_lesson_page_element").unbind("click"),b(this).css("background-color","white"),b(".mod_lesson_page_element").off("mouseenter mouseleave");var j={pageid:i,jumpid:h};b.ajax({method:"POST",url:e,dataType:"json",data:{action:"linklessonpages",lessonid:d,lessondata:j}}).done(function(a){f.pages[i].update_jumps(a),x()}).fail(function(a){console.log(a)}),H()},N=function(a){var c=a.currentTarget.id,d=c.split("_"),e=d[4],f=a.currentTarget.innerText,g="mod_lesson_inline_edit_"+e;a.currentTarget.innerHTML='<input type="text" id="'+g+'" value="'+f+'"/>',b("#"+g).keydown(function(b){13==b.which&&alert("save this title"),27==b.which&&(a.currentTarget.innerHTML=f)})},O=function(a){var c=b(this).attr("id"),d=c.split("_")[4],e=c.split("_")[5];b(".mod_lesson_jumpeditform").remove(),b.when(E(d)).done(function(a){var c='<div class="mod_lesson_jumpeditform" id="mod_lesson_jumpeditform_'+e+'">';c+="<h3>Jump options edit thing</h3>",c+='<div>Answer: <input type="text" value="'+f.pages[d].jumps[e].answer+'" /></div>',c+=v(f.pages[d].jumps[e].jumpto,f.pages[d].id,a,0),c+="<div>Score</div>",c+='<input type="score" value="'+f.pages[d].jumps[e].score+'" />',c+='<div><button type="button" id="mod_lesson_jumpeditor_save_btn">Save</button>',c+='<button type="button" id="mod_lesson_jumpeditor_cancel_btn">Cancel</button>',c+="</div>",b(".mod_lesson_pages").append(c),b("#mod_lesson_jumpeditor_cancel_btn").click(function(){b(".mod_lesson_jumpeditform").remove()})})},P=function(){var a=b(this).parents(".mod_lesson_page_element"),c=a.attr("id"),d=c.split("_")[4];for(index in f.pages[d].childrenids)b("#mod_lesson_page_element_"+f.pages[d].childrenids[index]).css("display","inline");a.animate({width:"700px",height:"500px",overflow:"scroll"},500,function(){a.css("z-index","2"),x()})},Q=function(){var a=b(this).parents(".mod_lesson_page_element"),c=a.attr("id"),d=c.split("_")[4];for(index in f.pages[d].childrenids)b("#mod_lesson_page_element_"+f.pages[d].childrenids[index]).css("display","none");a.animate({width:"300px",height:"175px",overflow:"scroll"},500,function(){a.css("z-index","0"),x()})},R=function(){b(".mod_lesson_page_element").draggable({drag:x,stop:S}),b(".mod_lesson_page_element").unbind("dblclick"),b(".mod_lesson_page_object_menu").unbind("click"),b(".mod_lesson_page_object_expand").on({click:P}),b(".mod_lesson_page_object_contract").on({click:Q}),b(".mod_lesson_page_object_menu").on({click:G}),b(".mod_lesson_menu_item").draggable({stop:D}),b("#mod_lesson_reset_button").click(function(){g=!0,U()}),b(".mod_lesson_page_element_body").on({dblclick:N})},S=function(a,c){var e=c.helper.position(),f=this.id,g=f.split("_"),h=g[4],i=b(".mod_lesson_pages").scrollTop(),j=b(".mod_lesson_pages").scrollLeft(),k={pageid:h,positionx:Math.round(e.left+1*j),positiony:Math.round(e.top+1*i)};if(k.positionx<0){k.positionx=0;var l=b("#mod_lesson_page_element_"+h);l.parent();l.css({position:"absolute",top:k.positiony,left:k.positionx})}if(k.positiony<40){k.positiony=40;var l=b("#mod_lesson_page_element_"+h);l.parent();l.css({position:"absolute",top:k.positiony,left:k.positionx})}var m={action:"saveposition",lessonid:d,lessondata:k};T(m)},T=function(a){b.ajax({method:"POST",url:e,dataType:"json",data:a}).done(function(){})},U=function(){var a=1,e=0,f=40;for(elementid in c)if(g){if("31"!==c[elementid].qtype&&"21"!==c[elementid].qtype){var h=b("#mod_lesson_page_element_"+elementid);h.css({position:"absolute",top:f,left:e});var i={action:"saveposition",lessonid:d,lessondata:{pageid:elementid,positionx:e,positiony:f}};T(i),a++,4!=a?e+=275:(e=0,f+=210,a=0)}}else if("31"!==c[elementid].qtype&&"21"!==c[elementid].qtype){var j=parseInt(c[elementid].x),k=parseInt(c[elementid].y),h=b("#mod_lesson_page_element_"+elementid);j<0&&(j=0),k<0&&(k=0),j+="px",k+="px",h.css({position:"absolute",top:k,left:j})}g&&(A(),B(),x(),g=!1)},V=function(a,c){var d=b.Deferred(),f={pageid:c},g=b.ajax({method:"POST",url:e,dataType:"json",data:{action:"getlessondata",lessonid:a,lessondata:f}});return g.done(function(a){d.resolve(a)}),g.fail(function(a){console.log(a)}),d.promise()},W=function(){for(index in f.pages)if(f.pages[index].positionx>0||f.pages[index].positiony>0)return void(g=!1)};return{init:function(a,e){d=a,b.when(V(a,e)).done(function(a){c=a,f=new h(c),W(),U(),A(),B(),x(),R(),b(".mod_lesson_menu").droppable({out:C,drop:function(a,b){b.draggable.remove()}})})}}});