define(["jquery","core/url","core/templates","core/notification","core/str","core/ajax","core/dragdrop-reorder","core/tree","core/dialogue","core/menu"],function(a,b,c,d,e,f,g,h,i,j){var k=null,l=null,m=null,n=function(c){c.preventDefault();var d=a('[data-region="competencyactions"]').data("competency"),e={competencyframeworkid:k.getCompetencyFrameworkId()};null==d||(e.parentid=d.id);var f=a.param(e),g=b.relativeUrl("/admin/tool/lp/editcompetency.php?"+f);window.location=g},o=function(){if("undefined"==typeof m&&(m=0),m!=l){var b=a('[data-region="filtercompetencies"]').data("frameworkid"),c=f.call([{methodname:"tool_lp_set_parent_competency",args:{competencyid:l,parentid:m}},{methodname:"tool_lp_data_for_competencies_manage_page",args:{competencyframeworkid:b,search:a('[data-region="filtercompetencies"] input').val()}}]);c[1].done(t).fail(d.exception)}},p=function(b){var c=(new h("[data-enhance=movetree]",function(b){m=a(b).data("id")}),a(b.getContent()));c.on("click",'[data-action="move"]',function(a){b.close(),o()}),c.on("click",'[data-action="cancel"]',function(a){b.close()})},q=function(a,b){var c;for(c=0;c<b.length;c++)b[c].parentid==a.id&&(a.haschildren=!0,b[c].children=[],b[c].haschildren=!1,a.children[a.children.length]=b[c],q(b[c],b))},r=function(b){b.preventDefault();var g=a('[data-region="competencyactions"]').data("competency");l=g.id;var h=f.call([{methodname:"tool_lp_search_competencies",args:{competencyframeworkid:g.competencyframeworkid,searchtext:""}},{methodname:"tool_lp_read_competency_framework",args:{id:g.competencyframeworkid}}]);a.when.apply(null,h).done(function(a,b){var f,h=[];for(f=0;f<a.length;f++){var j=a[f];0==j.parentid&&(j.children=[],j.haschildren=0,h[h.length]=j,q(j,a))}e.get_strings([{key:"movecompetency",component:"tool_lp",param:g.shortname},{key:"move",component:"tool_lp"},{key:"cancel",component:"tool_lp"}]).done(function(a){var e={framework:b,competencies:h};c.render("tool_lp/competencies_move_tree",e).done(function(b){new i(a[0],b,p)}).fail(d.exception)}).fail(d.exception)}).fail(d.exception)},s=function(c){c.preventDefault();var d=a('[data-region="competencyactions"]').data("competency"),e={competencyframeworkid:k.getCompetencyFrameworkId(),id:d.id,parentid:d.parentid},f=a.param(e),g=b.relativeUrl("/admin/tool/lp/editcompetency.php?"+f);window.location=g},t=function(b){c.render("tool_lp/manage_competencies_page",b).done(function(b,d){a('[data-region="managecompetencies"]').replaceWith(b),c.runTemplateJS(d)}).fail(d.exception)},u=function(b){b.preventDefault();var c=a('[data-region="filtercompetencies"]').data("frameworkid"),e=f.call([{methodname:"tool_lp_data_for_competencies_manage_page",args:{competencyframeworkid:c,search:a('[data-region="filtercompetencies"] input').val()}}]);e[0].done(t).fail(d.exception)},v=function(){var b=a('[data-region="competencyactions"]').data("competency"),c=f.call([{methodname:"tool_lp_move_up_competency",args:{id:b.id}},{methodname:"tool_lp_data_for_competencies_manage_page",args:{competencyframeworkid:b.competencyframeworkid,search:a('[data-region="filtercompetencies"] input').val()}}]);c[1].done(t).fail(d.exception)},w=function(){var b=a('[data-region="competencyactions"]').data("competency"),c=f.call([{methodname:"tool_lp_move_down_competency",args:{id:b.id}},{methodname:"tool_lp_data_for_competencies_manage_page",args:{competencyframeworkid:b.competencyframeworkid,search:a('[data-region="filtercompetencies"] input').val()}}]);c[1].done(t).fail(d.exception)},x=function(g){g.preventDefault();var h=a('[data-region="competencyactions"]').data("competency"),j=f.call([{methodname:"tool_lp_list_courses_using_competency",args:{id:h.id}}]);j[0].done(function(a){var f={courseviewurl:b.relativeUrl("/course/view.php"),courses:a};c.render("tool_lp/linked_courses_summary",f).done(function(a){e.get_string("linkedcourses","tool_lp").done(function(b){new i(b,a,p)}).fail(d.exception)}).fail(d.exception)}).fail(d.exception)},y=function(){var b=a('[data-region="competencyactions"]').data("competency"),c=f.call([{methodname:"tool_lp_delete_competency",args:{id:b.id}},{methodname:"tool_lp_data_for_competencies_manage_page",args:{competencyframeworkid:b.competencyframeworkid,search:a('[data-region="filtercompetencies"] input').val()}}]);c[1].done(t).fail(d.exception)},z=function(b){b.preventDefault();var f=a('[data-region="competencyactions"]').data("competency");c.render("tool_lp/competency_summary",f).done(function(a){e.get_strings([{key:"confirm",component:"tool_lp"},{key:"deletecompetency",component:"tool_lp",param:a},{key:"delete",component:"tool_lp"},{key:"cancel",component:"tool_lp"}]).done(function(a){d.confirm(a[0],a[1],a[2],a[3],y)}).fail(d.exception)}).fail(d.exception)},A=function(b){b.originalEvent.dataTransfer.setData("text",a(b.target).data("id"))},B=function(a){a.originalEvent.dataTransfer.dropEffect="move",a.preventDefault()},C=function(b){b.preventDefault(),a(this).addClass("currentdragtarget")},D=function(b){b.preventDefault(),a(this).removeClass("currentdragtarget")},E=function(b){b.preventDefault(),l=b.originalEvent.dataTransfer.getData("text"),m=a(b.target).data("id"),a(this).removeClass("currentdragtarget"),o()};return{init:function(b){k=b,e.get_string("edit","core").done(function(b){j.menu(b,".competencyactionsmenu"),a('[data-region="competencyactions"]').on("click",'[data-action="add"]',n),a('[data-region="competencyactions"]').on("click",'[data-action="edit"]',s),a('[data-region="competencyactions"]').on("click",'[data-action="delete"]',z),a('[data-region="competencyactions"]').on("click",'[data-action="move"]',r),a('[data-region="competencyactions"]').on("click",'[data-action="moveup"]',v),a('[data-region="competencyactions"]').on("click",'[data-action="movedown"]',w),a('[data-region="competencyactions"]').on("click",'[data-action="linkedcourses"]',x)}).fail(d.exception),a('[data-region="filtercompetencies"]').on("submit",u),a('[data-region="managecompetencies"] li').on("dragstart",A),a('[data-region="managecompetencies"] li').on("dragover",B),a('[data-region="managecompetencies"] li').on("dragenter",C),a('[data-region="managecompetencies"] li').on("dragleave",D),a('[data-region="managecompetencies"] li').on("drop",E)},selectionChanged:function(b){var e=a(b).data("id");if("undefined"==typeof e)a('[data-region="competencyinfo"]').html(b.clone().children().remove().end().text()),a('[data-region="competencyactions"]').data("competency",null),a('[data-region="competencyactionsmenu"]').hide(),a('[data-region="competencyactions"] [data-action="add"]').removeAttr("disabled");else{var f=k.getCompetency(e);c.render("tool_lp/competency_summary",f).done(function(b){a('[data-region="competencyinfo"]').html(b)}).fail(d.exception),a('[data-region="competencyactions"]').data("competency",f),a('[data-region="competencyactions"] [data-action="add"]').removeAttr("disabled"),a('[data-region="competencyactionsmenu"]').css("display","inline-block")}}}});