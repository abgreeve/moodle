define(["jqueryui","jquery"],function(a,b){var c=null,d=0,e="ajax.php",f=null,g=function(a){this.add_lessonpage=function(a,b){switch(parseInt(b.qtype)){case 31:this.pages[a]=new j(b);break;case 30:this.pages[a]=new i(b);break;case 21:this.pages[a]=new n(b);break;case 20:this.pages[a]=new o(b);break;case 10:this.pages[a]=new p(b);break;case 8:this.pages[a]=new l(b);break;case 5:this.pages[a]=new q(b);break;case 3:this.pages[a]=new r(b);break;case 2:this.pages[a]=new k(b);break;case 1:this.pages[a]=new m(b);break;default:this.pages[a]=new h(b)}},this.id=d,this.pages={};for(lessonpage in a)this.add_lessonpage(lessonpage,a[lessonpage])},h=function(a){this.id=a.id,this.qtype=parseInt(a.qtype),this.lessonid=a.lessonid,this.title=a.title,this.contents=a.contents,this.positionx=a.positionx,this.positiony=a.positiony,this.qtypestring=a.qtypestr,this.nextpageid=a.nextpageid,this.previouspageid=a.prevpageid,this.location=a.location,a.hasOwnProperty("clusterid")&&(this.clusterid=a.clusterid),a.hasOwnProperty("subclusterid")&&(this.subclusterid=a.subclusterid),this.jumps=[];for(var b=0,c="jumpto["+b+"]";a.hasOwnProperty(c);)this.jumps[this.jumps.length]=parseInt(a[c]),b+=1,c="jumpto["+b+"]";0===this.jumps.length&&(this.jumps[0]=-1,this.qtype<11&&(this.jumps[1]=0)),a.hasOwnProperty("subclusterchildrenids")&&(this.childrenids=a.subclusterchildrenids)};h.prototype={in_cluster:function(){return"cluster"===this.location?!0:!1},in_subcluster:function(){return"subcluster"==this.location?!0:!1},update_jumps:function(a){this.jumps=[];for(jumpid in a)this.jumps.push("-1"===a[jumpid]?this.nextpageid:parseInt(a[jumpid].jumpto))},get_default_edit_form:function(){var a='<div class="mod_lesson_page_editor">';return a+="<h3>Edit this "+this.qtypestring+" </h3>",a+=s(this.id,this.title),a+=t(this.id,this.contents)}};var i=function(a){h.call(this,a),"clusterchildrenids"in a?this.childrenids=a.clusterchildrenids:this.childrenids=[]};i.prototype={in_cluster:function(){return h.prototype.in_cluster.call(this)},update_jumps:function(a){h.prototype.update_jumps.call(this,a)},get_edit_form:function(a){return o.prototype.get_edit_form.call(this,a)}};var j=function(a){h.call(this,a)};j.prototype={in_cluster:function(){return h.prototype.in_cluster.call(this)},update_jumps:function(a){h.prototype.update_jumps.call(this,a)}};var k=function(a){h.call(this,a)};k.prototype={in_cluster:function(){return h.prototype.in_cluster.call(this)},in_subcluster:function(){return h.prototype.in_subcluster.call(this)},update_jumps:function(a){h.prototype.update_jumps.call(this,a)},get_edit_form:function(a){return o.prototype.get_edit_form.call(this,a)}};var l=function(a){h.call(this,a)};l.prototype={in_cluster:function(){return h.prototype.in_cluster.call(this)},in_subcluster:function(){return h.prototype.in_subcluster.call(this)},update_jumps:function(a){h.prototype.update_jumps.call(this,a)},get_edit_form:function(a){return o.prototype.get_edit_form.call(this,a)}};var m=function(a){h.call(this,a)};m.prototype={in_cluster:function(){return h.prototype.in_cluster.call(this)},in_subcluster:function(){return h.prototype.in_subcluster.call(this)},update_jumps:function(a){h.prototype.update_jumps.call(this,a)},get_edit_form:function(a){return o.prototype.get_edit_form.call(this,a)}};var n=function(a){h.call(this,a)};n.prototype={in_cluster:function(){return h.prototype.in_cluster.call(this)},update_jumps:function(a){h.prototype.update_jumps.call(this,a)}};var o=function(a){h.call(this,a)};o.prototype={in_cluster:function(){return h.prototype.in_cluster.call(this)},in_subcluster:function(){return h.prototype.in_subcluster.call(this)},update_jumps:function(a){h.prototype.update_jumps.call(this,a)},get_edit_form:function(a){var b=h.prototype.get_default_edit_form.call(this),c=1;for(jumpid in this.jumps)b+="<h4>Content "+c+"</h4>",b+="<div>Jump name</div>",b+='<div><input type="text" id="jumpname" /></div>',b+=u(this.jumps[jumpid],this.id,a,c),c++;return b+='<div><button type="button" id="mod_lesson_editor_save_btn">Save</button>',b+='<button type="button" id="mod_lesson_editor_cancel_btn">Cancel</button></div>',b+="</div>"}};var p=function(a){h.call(this,a)};p.prototype={in_cluster:function(){return h.prototype.in_cluster.call(this)},in_subcluster:function(){return h.prototype.in_subcluster.call(this)},update_jumps:function(a){h.prototype.update_jumps.call(this,a)},get_edit_form:function(a){return o.prototype.get_edit_form.call(this,a)}};var q=function(a){h.call(this,a)};q.prototype={in_cluster:function(){return h.prototype.in_cluster.call(this)},in_subcluster:function(){return h.prototype.in_subcluster.call(this)},update_jumps:function(a){h.prototype.update_jumps.call(this,a)},get_edit_form:function(a){return o.prototype.get_edit_form.call(this,a)}};var r=function(a){h.call(this,a)};r.prototype={in_cluster:function(){return h.prototype.in_cluster.call(this)},in_subcluster:function(){return h.prototype.in_subcluster.call(this)},update_jumps:function(a){h.prototype.update_jumps.call(this,a)},get_edit_form:function(a){return o.prototype.get_edit_form.call(this,a)}};var s=function(a,b){var c;return c="<div>Page Title</div>",c+='<div><input type="input" class="mod_lesson_title" id="mod_lesson_title_'+a+'" value="'+b+'" /></div>'},t=function(a,b){var c;return c="<div>Page Content</div>",c+='<div><textarea id="mod_lesson_contents_'+a+'">'+b+"</textarea></div>"},u=function(a,c,d,e){var f;return f="<div>Jump</div>",f+='<select id="mod_lesson_jump_select_'+c+"_"+e+'">',b.each(d,function(b,c){f+=a==b?'<option value="'+b+'" selected>'+c.title+"</option>":'<option value="'+b+'">'+c.title+"</option>"}),f+="</select>"},v=function(a,c){if(0!==c&&document.getElementById("mod_lesson_page_element_"+a)&&document.getElementById("mod_lesson_page_element_"+c)){var d=b("#mod_lesson_page_element_"+a).offset(),e=b("#mod_lesson_page_element_"+c).offset(),f=d.left+b("#mod_lesson_page_element_"+a).width(),g=d.top+b("#mod_lesson_page_element_"+a).height(),h=Math.sqrt((e.left-f)*(e.left-f)+(e.top-g)*(e.top-g)),i=Math.atan2(g-e.top,f-e.left)*(180/Math.PI),j=(f+e.left)/2-h/2,k=(g+e.top)/2-1,l="<div class='lessonline' style='left:"+j+"px; top:"+k+"px; width:"+h+"px;";l+=" -moz-transform:rotate("+i+"deg); -webkit-transform:rotate("+i+"deg);",l+=" -o-transform:rotate("+i+"deg); -ms-transform:rotate("+i+"deg);",l+=" transform:rotate("+i+"deg);' />",b("body").append(l)}},w=function(){b(".lessonline").remove();for(lpid in f.pages){var a=f.pages[lpid];for(jumpid in a.jumps)-1==a.jumps[jumpid]?nextpageid=a.nextpageid:nextpageid=a.jumps[jumpid],31==a.qtype?v(a.clusterid,nextpageid):"-9"===nextpageid?v(a.id,a.id+"1"):a.in_cluster()||v(a.id,nextpageid)}},x=function(a,c){var d=c.helper.attr("id"),g=d.split("_"),h=g[4],i=b(this).find(c.helper).length;if(!i){var j=b(this).attr("id");g=j.split("_");var k=g[4];f.pages[h].location="cluster";var l=null;l=f.pages[k].childrenids.length>0?f.pages[k].childrenids[f.pages[k].childrenids.length-1]:f.pages[k].id,-1==b.inArray(h,f.pages[k].childrenids)&&f.pages[k].childrenids.push(h);var m=f.pages[h].previouspageid,n=f.pages[h].nextpageid;"0"!==m&&(f.pages[m].nextpageid=n),"0"!==n&&(f.pages[n].previouspageid=m),lessondata={pageid:h,after:l},b.ajax({method:"POST",url:e,dataType:"json",data:{action:"movepage",lessonid:f.id,lessondata:lessondata}}).done(function(a){}),i||(c.helper.detach(),b(this).append(c.helper),z()),console.log(f)}},y=function(a,c){var d=b(this).find(c.helper).length;d&&(c.helper.detach(),b(".mod_lesson_pages").append(c.helper),z())},z=function(){for(var a in f.pages){var c=f.pages[a];if(30===c.qtype){var d=c.childrenids.length,e=270,g=100,h=b("#mod_lesson_page_element_"+a).height(),i=0,j=0;if(d>3)i=3*e,additionalheight=Math.ceil(d/3)*g+10,j=100+additionalheight;else{var k=d;0==d&&(k=1),i=e*k,j=200==h?h:h+1*g}if(b("#mod_lesson_page_element_"+a).width(i),b("#mod_lesson_page_element_"+a).height(j),d){var l=b("#mod_lesson_page_element_"+a).offset().left+10,m=l,n=b("#mod_lesson_page_element_"+a).offset().top+80;for(var o in c.childrenids)o%3===0&&"0"!==o?(n+=110,b("#mod_lesson_page_element_"+c.childrenids[o]).offset({top:n,left:l}),m=l+b("#mod_lesson_page_element_"+c.childrenids[o]).width()+30):(b("#mod_lesson_page_element_"+c.childrenids[o]).offset({top:n,left:m}),m=m+b("#mod_lesson_page_element_"+c.childrenids[o]).width()+30)}b("#mod_lesson_page_element_"+a).droppable({drop:x,out:y})}}},A=function(){for(var a in f.pages){var c=f.pages[a];if(20===c.qtype&&c.in_subcluster()){var d=c.childrenids.length;0===d&&(d=1);var e=250,g=100,h=b("#mod_lesson_page_element_"+a).height(),i=0,j=0;d>3?(i=3*e,j=h+Math.ceil(d/3)*g):(i=e*d,j=h+1*g),b("#mod_lesson_page_element_"+a).width(i),b("#mod_lesson_page_element_"+a).height(j);var k=b("#mod_lesson_page_element_"+a).offset().left+10,l=k,m=b("#mod_lesson_page_element_"+a).offset().top+80;for(var n in c.childrenids)n%3===0&&"0"!==n?(m+=110,b("#mod_lesson_page_element_"+c.childrenids[n]).offset({top:m,left:k}),l=k+b("#mod_lesson_page_element_"+c.childrenids[n]).width()+30):(b("#mod_lesson_page_element_"+c.childrenids[n]).offset({top:m,left:l}),l=l+b("#mod_lesson_page_element_"+c.childrenids[n]).width()+30);b("#mod_lesson_page_element_"+a+"_header").html("Sub cluster"),b("#mod_lesson_page_element_"+a).droppable({drop:x,out:y})}}},B=function(a,c){pagetype=c.helper.text();var d="<div class='mod_lesson_menu_item'>"+pagetype+"</div>";b(".mod_lesson_menu").append(d),b(".mod_lesson_menu_item").draggable({stop:C})},C=function(a,c){var d,g,h,i,j=c.helper.text();switch(j){case"Content":d="20",g="",h="Default title",i="normal";break;case"True False":d="2",g="",h="Default title",i="normal";break;case"Numerical":d="8",g="",h="Default title",i="normal";break;case"Multiple Choice":d="3",g="",h="Default title",i="normal";break;case"Cluster":d="30",g="Cluster",h="Cluster",i="cluster";break;default:d="0",g="",h="Default title",i="normal"}if(!c.helper.hasClass("mod_lesson_page_element")){var k=c.helper.offset();c.helper.addClass("mod_lesson_page_element"),c.helper.removeClass("mod_lesson_menu_item");var l={title:h,contents:g,qtype:d,lessonid:f.id,location:i,previouspageid:"0",nextpageid:"0",positionx:Math.round(k.left),positiony:Math.round(k.top)};b.ajax({method:"POST",url:e,dataType:"json",data:{action:"createcontent",lessonid:f.id,lessondata:l}}).done(function(a){if("31"!==a.qtype){c.helper.attr("id","mod_lesson_page_element_"+a.id);var d='<header id="mod_lesson_page_element_'+a.id+'">'+j;d+='<img src="../../theme/image.php?theme=clean&component=core&image=t%2Fedit" class="mod_lesson_page_object_menu"></div></header>',d+='<div class="mod_lesson_page_element_body" id="mod_lesson_page_element_'+a.id+'_body">'+a.title+"</div>",b("#mod_lesson_page_element_"+a.id).html(d)}if(f.add_lessonpage(a.id,a),f.pages[a.prevpageid].nextpageid=a.id,"30"===a.qtype){var e=parseInt(a.id)+1,g={clusterid:a.id,contents:"End of cluster",id:e,lessonid:f.id,location:"normal",nextpageid:"0",positionx:"0",positiony:"0",qtype:31,qtypestring:"End of cluster",title:"End of cluster"};f.add_lessonpage(e,g),f.pages[a.id].nextpageid=e}"31"!==a.qtype&&(c.helper.detach(),b(".mod_lesson_pages").append(c.helper),b("#mod_lesson_page_element_"+a.id).offset(k),"Cluster"===j&&z(),O(),w())}).fail(function(a){console.log(a)})}w(),O()},D=function(){var a=b.Deferred(),c=b.ajax({method:"POST",url:e,dataType:"json",data:{action:"getjumpoptions",lessonid:d}});return c.done(function(b){a.resolve(b)}),c.fail(function(a){console.log(a)}),a.promise()},E=function(a){a.preventDefault(),a.stopPropagation(),console.log(b(this).parents(".mod_lesson_page_element").attr("id"));var c=b(this).parents(".mod_lesson_page_element").attr("id"),d=c.split("_"),e=d[4];H(),b.when(D()).done(function(a){var c=f.pages[e].get_edit_form(a);b(".mod_lesson_pages").append(c),b("#mod_lesson_editor_save_btn").click({pageid:e},F),b("#mod_lesson_editor_cancel_btn").click(function(){b(".mod_lesson_page_editor").remove()})})},F=function(a){var c={id:a.data.pageid,title:b("#mod_lesson_title_"+a.data.pageid).val()};b.ajax({method:"POST",url:e,dataType:"json",data:{action:"updatelessonpage",lessonid:d,lessondata:c}}).done(function(a){b("#mod_lesson_page_element_"+c.id+"_body").html(c.title),b(".mod_lesson_page_editor").remove()})},G=function(a){if(b(this).parent().children(".mod_lesson_page_object_menu_thing").length)b(this).parent().find(".mod_lesson_page_object_menu_thing").remove();else{var c='<div class="mod_lesson_page_object_menu_thing">';c+="<ul>",c+='<li><a href="#" class="mod_lesson_page_edit">Edit</a></li>',c+='<li><a href="#" class="mod_lesson_page_link">Link</a></li>',c+='<li><a href="#" class="mod_lesson_page_delete">Delete</a></li>',c+="</ul>",c+="</div>",b(this).parent().append(c),b(".mod_lesson_page_delete").on({click:I}),b(".mod_lesson_page_edit").on({click:E}),b(".mod_lesson_page_link").on({click:J})}},H=function(){b(".mod_lesson_main").find(".mod_lesson_page_object_menu_thing").remove()},I=function(a){a.preventDefault();var c=b(this).parents(".mod_lesson_page_element").attr("id"),g=c.split("_"),h=g[4],i={};if(30==f.pages[h].qtype)for(index in f.pages)parseInt(f.pages[index].clusterid)==h&&(i.endofclusterid=f.pages[index].id);b.ajax({method:"POST",url:e,dataType:"json",data:{action:"deletelessonpage",lessonid:d,pageid:h,lessondata:i}}).done(function(){30==f.pages[h].qtype&&delete f.pages[i.endofclusterid],delete f.pages[h],console.log(f)}).fail(function(a){console.log(a)}),b(this).parents(".mod_lesson_page_element").remove(),H(),w()},J=function(a){a.preventDefault(),a.stopPropagation();var c=b(this).parent().parent().parent().parent().attr("id"),d=c.split("_"),e=d[4];b(".mod_lesson_page_element").click({pageid:e},M),b(".mod_lesson_page_element").hover(K,L)},K=function(){b(this).css("background-color","#b8b8b8")},L=function(){b(this).css("background-color","white")},M=function(a){var c=this.id,g=c.split("_"),h=g[4],i=a.data.pageid;b(".mod_lesson_page_element").unbind("click"),b(this).css("background-color","white"),b(".mod_lesson_page_element").off("mouseenter mouseleave");var j={pageid:i,jumpid:h};b.ajax({method:"POST",url:e,dataType:"json",data:{action:"linklessonpages",lessonid:d,lessondata:j}}).done(function(a){f.pages[i].update_jumps(a),w()}).fail(function(a){console.log(a)}),H()},N=function(a){var c=a.currentTarget.id,d=c.split("_"),e=d[4],f=a.currentTarget.innerText,g="mod_lesson_inline_edit_"+e;a.currentTarget.innerHTML='<input type="text" id="'+g+'" value="'+f+'"/>',b("#"+g).keydown(function(b){13==b.which&&alert("save this title"),27==b.which&&(a.currentTarget.innerHTML=f),console.log(b.which)})},O=function(){b(".mod_lesson_page_element").draggable({drag:w,stop:P}),b(".mod_lesson_page_element").unbind("dblclick"),b(".mod_lesson_page_object_menu").unbind("click"),b(".mod_lesson_page_object_menu").on({click:G}),b(".mod_lesson_menu_item").draggable({stop:C}),b(".mod_lesson_pages").scroll(function(){w()}),b(".mod_lesson_page_element_body").on({dblclick:N})},P=function(a,c){var f=c.helper.position(),g=this.id,h=g.split("_"),i=h[4],j={pageid:i,positionx:Math.round(f.left),positiony:Math.round(f.top)};b.ajax({method:"POST",url:e,dataType:"json",data:{action:"saveposition",lessonid:d,lessondata:j}}).done(function(){})},Q=function(){for(elementid in c)if("31"!==c[elementid].qtype&&"21"!==c[elementid].qtype){var a=c[elementid].x,d=c[elementid].y,e=b("#mod_lesson_page_element_"+elementid),f=e.parent();e.position({my:"left top",at:"left+"+a+" top+"+d,of:f})}},R=function(a,c){var d=b.Deferred(),f={pageid:c},g=b.ajax({method:"POST",url:e,dataType:"json",data:{action:"getlessondata",lessonid:a,lessondata:f}});return g.done(function(a){d.resolve(a)}),g.fail(function(a){console.log(a)}),d.promise()};return{init:function(a,e){d=a,b.when(R(a,e)).done(function(a){c=a,console.log(c),f=new g(c),console.log(f),z(),A(),Q(),w(),O(),b(".mod_lesson_menu").droppable({out:B,drop:function(a,b){b.draggable.remove()}})})}}});